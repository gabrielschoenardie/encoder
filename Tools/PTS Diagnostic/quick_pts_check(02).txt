@echo off
setlocal enabledelayedexpansion

REM ================================
REM Quick PTS Check - Verifica√ß√£o R√°pida
REM Resposta em 5 segundos: precisa genpts ou n√£o?
REM ================================

set INPUT_FILE=%1

if "%INPUT_FILE%"=="" (
    echo.
    echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    echo ‚ïë        Quick PTS Check            ‚ïë
    echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    echo.
    echo Usage: quick_pts_check.bat "video.mp4"
    echo.
    echo Verifica√ß√£o r√°pida se precisa -fflags +genpts
    echo.
    exit /b 1
)

if not exist "%INPUT_FILE%" (
    echo ‚ùå Arquivo n√£o encontrado: %INPUT_FILE%
    exit /b 1
)

echo.
echo üîç Verificando: %~nx1
echo ‚è±Ô∏è  Aguarde ~5 segundos...
echo.

REM ================================
REM CHECK 1: FFmpeg Warnings
REM ================================
ffmpeg -v warning -i "%INPUT_FILE%" -t 1 -f null - 2> "%TEMP%\quick_check.log"

set PTS_PROBLEMS=0

findstr /i "non-monotonous" "%TEMP%\quick_check.log" >nul 2>&1
if %errorlevel%==0 (
    echo ‚ùå Non-monotonous PTS detectado
    set PTS_PROBLEMS=1
)

findstr /i "discontinuity" "%TEMP%\quick_check.log" >nul 2>&1
if %errorlevel%==0 (
    echo ‚ùå DTS discontinuity detectado  
    set PTS_PROBLEMS=1
)

findstr /i "invalid" "%TEMP%\quick_check.log" >nul 2>&1
if %errorlevel%==0 (
    echo ‚ùå Invalid timestamps detectados
    set PTS_PROBLEMS=1
)

REM ================================
REM CHECK 2: Source Type Detection
REM ================================
set SCREEN_RECORDING=0

ffprobe -v quiet -show_entries format_tags=encoder -of csv=print_section=0 "%INPUT_FILE%" | findstr /i "obs\|bandicam\|fraps\|camtasia\|xsplit" >nul 2>&1
if %errorlevel%==0 (
    echo üéÆ Screen recording detectado
    set SCREEN_RECORDING=1
)

REM ================================
REM CHECK 3: File Characteristics  
REM ================================
set SUSPICIOUS_FILE=0

for %%i in ("%INPUT_FILE%") do set FILE_SIZE=%%~zi

REM Arquivo muito pequeno pode ter problemas
if %FILE_SIZE% LSS 500000 (
    echo ‚ö†Ô∏è  Arquivo muito pequeno ^(^<%FILE_SIZE% bytes^)
    set SUSPICIOUS_FILE=1
)

REM ================================
REM DECISION LOGIC
REM ================================
echo.
echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
echo ‚ïë             RESULTADO                 ‚ïë  
echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

if %PTS_PROBLEMS%==1 (
    echo.
    echo üéØ USAR: -fflags +genpts
    echo üîç Raz√£o: Problemas de PTS/DTS detectados
    echo ‚ö†Ô∏è  Cr√≠tico: Sem genpts vai dar problema
    echo.
    echo üíª Comando:
    echo    ffmpeg -i "input.mp4" -fflags +genpts [outros par√¢metros] "output.mp4"
    goto end
)

if %SCREEN_RECORDING%==1 (
    echo.
    echo üéØ USAR: -fflags +genpts  
    echo üîç Raz√£o: Screen recording detectado
    echo üí° Recomendado: Screen recordings frequentemente precisam
    echo.
    echo üíª Comando:
    echo    ffmpeg -i "input.mp4" -fflags +genpts [outros par√¢metros] "output.mp4"
    goto end
)

if %SUSPICIOUS_FILE%==1 (
    echo.
    echo ü§î TESTAR: Com e sem genpts
    echo üîç Raz√£o: Caracter√≠sticas suspeitas detectadas
    echo üí° Sugest√£o: Teste os dois e compare
    echo.
    echo üíª Comandos para teste:
    echo    ffmpeg -i "input.mp4" [par√¢metros] "output_sem.mp4"
    echo    ffmpeg -i "input.mp4" -fflags +genpts [par√¢metros] "output_com.mp4"
    goto end
)

echo.
echo üéØ N√ÉO USAR: -fflags +genpts
echo üîç Raz√£o: Nenhum problema detectado
echo ‚úÖ Arquivo parece limpo, PTS provavelmente OK
echo.
echo üíª Comando:
echo    ffmpeg -i "input.mp4" [outros par√¢metros] "output.mp4"

:end
echo.

REM Cleanup
del "%TEMP%\quick_check.log" 2>nul

echo üí° Para an√°lise completa: pts_diagnostic.bat "%INPUT_FILE%"
echo.