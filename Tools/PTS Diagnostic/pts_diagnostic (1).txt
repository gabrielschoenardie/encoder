@echo off
setlocal enabledelayedexpansion

REM ================================
REM Instagram PTS Diagnostic Tool
REM Analisa timestamps e recomenda configuraÃ§Ã£o
REM ================================

set INPUT_FILE=%1
set OUTPUT_DIR=%~dp1diagnostic_output
set TEMP_DIR=%TEMP%\pts_analysis

if "%INPUT_FILE%"=="" (
    echo.
    echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    echo â•‘     Instagram PTS Diagnostic Tool    â•‘
    echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    echo.
    echo Usage: pts_diagnostic.bat "video_file.mp4"
    echo.
    echo Este script analisa timestamps do video e recomenda
    echo se deve usar -fflags +genpts para Instagram
    echo.
    exit /b 1
)

if not exist "%INPUT_FILE%" (
    echo âŒ ERRO: Arquivo nÃ£o encontrado: %INPUT_FILE%
    exit /b 1
)

REM Criar diretÃ³rios de trabalho
if not exist "%OUTPUT_DIR%" mkdir "%OUTPUT_DIR%"
if not exist "%TEMP_DIR%" mkdir "%TEMP_DIR%"

echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘                   INSTAGRAM PTS DIAGNOSTIC                   â•‘
echo â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
echo â•‘ Analisando: %~nx1
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

REM ================================
REM ETAPA 1: AnÃ¡lise BÃ¡sica do Arquivo
REM ================================
echo [1/6] ðŸ“ AnÃ¡lise bÃ¡sica do arquivo...

ffprobe -v quiet -print_format json -show_format -show_streams "%INPUT_FILE%" > "%TEMP_DIR%\info.json"

REM Extrai informaÃ§Ãµes bÃ¡sicas
for /f "tokens=2 delims=:" %%a in ('findstr "duration" "%TEMP_DIR%\info.json" ^| head -1') do set DURATION=%%a
for /f "tokens=2 delims=:" %%a in ('findstr "avg_frame_rate" "%TEMP_DIR%\info.json"') do set FRAMERATE=%%a
for /f "tokens=2 delims=:" %%a in ('findstr "width" "%TEMP_DIR%\info.json"') do set WIDTH=%%a
for /f "tokens=2 delims=:" %%a in ('findstr "height" "%TEMP_DIR%\info.json"') do set HEIGHT=%%a

set DURATION=%DURATION: =%
set DURATION=%DURATION:"=%
set DURATION=%DURATION:,=%

set FRAMERATE=%FRAMERATE: =%
set FRAMERATE=%FRAMERATE:"=%
set FRAMERATE=%FRAMERATE:,=%

set WIDTH=%WIDTH: =%
set WIDTH=%WIDTH:"=%
set WIDTH=%WIDTH:,=%

set HEIGHT=%HEIGHT: =%
set HEIGHT=%HEIGHT:"=%
set HEIGHT=%HEIGHT:,=%

echo    âœ“ DuraÃ§Ã£o: %DURATION%s
echo    âœ“ ResoluÃ§Ã£o: %WIDTH%x%HEIGHT%
echo    âœ“ Frame Rate: %FRAMERATE%
echo.

REM ================================
REM ETAPA 2: DetecÃ§Ã£o de Problemas PTS
REM ================================
echo [2/6] ðŸ” Detectando problemas de timestamps...

REM Verifica warnings durante anÃ¡lise
ffmpeg -v warning -i "%INPUT_FILE%" -f null - 2> "%TEMP_DIR%\warnings.txt"

set PTS_WARNINGS=0
set DTS_WARNINGS=0
set SYNC_WARNINGS=0

findstr /i "non-monotonous" "%TEMP_DIR%\warnings.txt" >nul 2>&1
if %errorlevel%==0 set /a PTS_WARNINGS+=1

findstr /i "discontinuity" "%TEMP_DIR%\warnings.txt" >nul 2>&1  
if %errorlevel%==0 set /a DTS_WARNINGS+=1

findstr /i "invalid" "%TEMP_DIR%\warnings.txt" >nul 2>&1
if %errorlevel%==0 set /a SYNC_WARNINGS+=1

findstr /i "corrupt" "%TEMP_DIR%\warnings.txt" >nul 2>&1
if %errorlevel%==0 set /a SYNC_WARNINGS+=1

REM Extrai primeiros 100 timestamps para anÃ¡lise
ffprobe -v quiet -select_streams v:0 -show_entries packet=pts_time,dts_time,duration_time -of csv=print_section=0 "%INPUT_FILE%" | head -100 > "%TEMP_DIR%\timestamps.csv"

echo    ðŸ“Š AnÃ¡lise de warnings:
if %PTS_WARNINGS%==0 (
    echo       âœ… PTS: Nenhum problema detectado
) else (
    echo       âŒ PTS: %PTS_WARNINGS% warning(s) encontrado(s)
)

if %DTS_WARNINGS%==0 (
    echo       âœ… DTS: Nenhum problema detectado  
) else (
    echo       âŒ DTS: %DTS_WARNINGS% warning(s) encontrado(s)
)

if %SYNC_WARNINGS%==0 (
    echo       âœ… SYNC: Nenhum problema detectado
) else (
    echo       âŒ SYNC: %SYNC_WARNINGS% warning(s) encontrado(s)
)

REM ================================
REM ETAPA 3: AnÃ¡lise de Regularidade dos Timestamps
REM ================================
echo.
echo [3/6] ðŸ“ˆ Analisando regularidade dos timestamps...

REM AnÃ¡lise bÃ¡sica dos timestamps (simulada via batch)
set TIMESTAMP_ISSUES=0
set EXPECTED_INTERVAL=0.033333

REM Conta linhas vÃ¡lidas
for /f %%i in ('type "%TEMP_DIR%\timestamps.csv" ^| find /c /v ""') do set FRAME_COUNT=%%i

echo    ðŸ“Š AnÃ¡lise de timestamps:
echo       ðŸŽ¬ Frames analisados: %FRAME_COUNT%
echo       â±ï¸  Intervalo esperado: %EXPECTED_INTERVAL%s (30fps)

REM Verifica se hÃ¡ timestamps suficientes
if %FRAME_COUNT% LSS 10 (
    echo       âš ï¸  Poucos frames para anÃ¡lise confiÃ¡vel
    set /a TIMESTAMP_ISSUES+=1
)

REM ================================
REM ETAPA 4: DetecÃ§Ã£o do Tipo de Source
REM ================================
echo.
echo [4/6] ðŸŽ¥ Detectando tipo de source...

set SOURCE_TYPE=UNKNOWN
set GENPTS_RECOMMENDED=0

REM DetecÃ§Ã£o por metadata
ffprobe -v quiet -show_entries format_tags=encoder -of csv=print_section=0 "%INPUT_FILE%" > "%TEMP_DIR%\encoder.txt"

findstr /i "obs" "%TEMP_DIR%\encoder.txt" >nul 2>&1
if %errorlevel%==0 (
    set SOURCE_TYPE=SCREEN_RECORDING
    set GENPTS_RECOMMENDED=1
    echo    ðŸŽ® Tipo detectado: Screen Recording ^(OBS^)
    echo       ðŸ’¡ RecomendaÃ§Ã£o: Usar -fflags +genpts
    goto source_detected
)

findstr /i "bandicam\|fraps\|camtasia" "%TEMP_DIR%\encoder.txt" >nul 2>&1
if %errorlevel%==0 (
    set SOURCE_TYPE=SCREEN_RECORDING
    set GENPTS_RECOMMENDED=1
    echo    ðŸŽ® Tipo detectado: Screen Recording
    echo       ðŸ’¡ RecomendaÃ§Ã£o: Usar -fflags +genpts
    goto source_detected
)

findstr /i "ffmpeg" "%TEMP_DIR%\encoder.txt" >nul 2>&1
if %errorlevel%==0 (
    set SOURCE_TYPE=FFMPEG_CONVERTED
    echo    ðŸ”„ Tipo detectado: Convertido via FFmpeg
    echo       ðŸ’¡ RecomendaÃ§Ã£o: Testar com e sem genpts
    goto source_detected
)

findstr /i "handbrake" "%TEMP_DIR%\encoder.txt" >nul 2>&1
if %errorlevel%==0 (
    set SOURCE_TYPE=HANDBRAKE_CONVERTED
    echo    ðŸ”„ Tipo detectado: Convertido via HandBrake
    echo       ðŸ’¡ RecomendaÃ§Ã£o: Provavelmente nÃ£o precisa genpts
    goto source_detected
)

REM DetecÃ§Ã£o por caracterÃ­sticas do arquivo
if %WIDTH%==1920 if %HEIGHT%==1080 (
    set SOURCE_TYPE=CAMERA_PHONE
    echo    ðŸ“± Tipo detectado: CÃ¢mera/Celular ^(1080p^)
    echo       ðŸ’¡ RecomendaÃ§Ã£o: Provavelmente nÃ£o precisa genpts
    goto source_detected
)

if %WIDTH%==3840 if %HEIGHT%==2160 (
    set SOURCE_TYPE=CAMERA_4K
    echo    ðŸ“· Tipo detectado: CÃ¢mera 4K
    echo       ðŸ’¡ RecomendaÃ§Ã£o: Provavelmente nÃ£o precisa genpts
    goto source_detected
)

echo    â“ Tipo detectado: Desconhecido
echo       ðŸ’¡ RecomendaÃ§Ã£o: Fazer teste A/B

:source_detected

REM ================================
REM ETAPA 5: DecisÃ£o AutomÃ¡tica
REM ================================
echo.
echo [5/6] ðŸ§  DecisÃ£o automÃ¡tica...

set FINAL_RECOMMENDATION=NO_GENPTS
set CONFIDENCE=LOW

REM LÃ³gica de decisÃ£o
if %PTS_WARNINGS% GTR 0 (
    set FINAL_RECOMMENDATION=USE_GENPTS
    set CONFIDENCE=HIGH
    echo    ðŸŽ¯ DecisÃ£o: USAR -fflags +genpts
    echo       ðŸ” RazÃ£o: PTS warnings detectados
    goto decision_made
)

if %DTS_WARNINGS% GTR 0 (
    set FINAL_RECOMMENDATION=USE_GENPTS  
    set CONFIDENCE=HIGH
    echo    ðŸŽ¯ DecisÃ£o: USAR -fflags +genpts
    echo       ðŸ” RazÃ£o: DTS warnings detectados
    goto decision_made
)

if %GENPTS_RECOMMENDED%==1 (
    set FINAL_RECOMMENDATION=USE_GENPTS
    set CONFIDENCE=MEDIUM
    echo    ðŸŽ¯ DecisÃ£o: USAR -fflags +genpts
    echo       ðŸ” RazÃ£o: Tipo de source requer genpts
    goto decision_made
)

if %TIMESTAMP_ISSUES% GTR 0 (
    set FINAL_RECOMMENDATION=TEST_BOTH
    set CONFIDENCE=LOW
    echo    ðŸŽ¯ DecisÃ£o: TESTAR AMBOS
    echo       ðŸ” RazÃ£o: Timestamps suspeitos, requer teste
    goto decision_made
)

echo    ðŸŽ¯ DecisÃ£o: NÃƒO USAR -fflags +genpts
echo       ðŸ” RazÃ£o: Nenhum problema detectado
set CONFIDENCE=MEDIUM

:decision_made

REM ================================
REM ETAPA 6: Teste A/B (se necessÃ¡rio)
REM ================================
echo.
echo [6/6] ðŸ§ª Executando teste A/B...

if "%FINAL_RECOMMENDATION%"=="TEST_BOTH" (
    echo    ðŸ”¬ Realizando teste A/B automÃ¡tico...
    call :run_ab_test
) else (
    echo    âœ… Teste A/B nÃ£o necessÃ¡rio - decisÃ£o confiÃ¡vel
)

REM ================================
REM RELATÃ“RIO FINAL
REM ================================
echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘                        RELATÃ“RIO FINAL                      â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo ðŸ“ Arquivo: %~nx1
echo ðŸŽ¥ Tipo: %SOURCE_TYPE%
echo ðŸ“Š ConfianÃ§a: %CONFIDENCE%
echo.
echo ðŸŽ¯ RECOMENDAÃ‡ÃƒO FINAL:
if "%FINAL_RECOMMENDATION%"=="USE_GENPTS" (
    echo    âœ… USAR: -fflags +genpts
    echo.
    echo ðŸ’» Comando sugerido:
    echo    ffmpeg -i "input.mp4" -fflags +genpts [outros parÃ¢metros] "output.mp4"
) else if "%FINAL_RECOMMENDATION%"=="TEST_BOTH" (
    echo    ðŸ§ª TESTAR AMBOS: Com e sem genpts
    echo.
    echo ðŸ’» Comandos para teste:
    echo    ffmpeg -i "input.mp4" [parÃ¢metros] "output_sem_genpts.mp4"
    echo    ffmpeg -i "input.mp4" -fflags +genpts [parÃ¢metros] "output_com_genpts.mp4"
) else (
    echo    âœ… NÃƒO USAR: -fflags +genpts
    echo.
    echo ðŸ’» Comando sugerido:
    echo    ffmpeg -i "input.mp4" [outros parÃ¢metros] "output.mp4"
)

echo.
echo ðŸ“‹ Detalhes tÃ©cnicos salvos em: %OUTPUT_DIR%
echo.

REM Salva relatÃ³rio detalhado
call :save_report

echo âœ… AnÃ¡lise concluÃ­da!
echo.
goto :eof

REM ================================
REM FUNÃ‡ÃƒO: Teste A/B
REM ================================
:run_ab_test
echo       ðŸŽ¬ Criando clips de teste (10 segundos)...

ffmpeg -v quiet -i "%INPUT_FILE%" -t 10 -c copy "%TEMP_DIR%\test_clip.mp4" -y

echo       ðŸ”§ Encoding SEM genpts...
ffmpeg -v quiet -i "%TEMP_DIR%\test_clip.mp4" -c:v libx264 -preset fast -crf 23 -c:a aac "%OUTPUT_DIR%\test_sem_genpts.mp4" -y 2>"%TEMP_DIR%\test_a_log.txt"

echo       ðŸ”§ Encoding COM genpts...  
ffmpeg -v quiet -i "%TEMP_DIR%\test_clip.mp4" -fflags +genpts -c:v libx264 -preset fast -crf 23 -c:a aac "%OUTPUT_DIR%\test_com_genpts.mp4" -y 2>"%TEMP_DIR%\test_b_log.txt"

REM Analisa logs dos testes
findstr /i "error\|warning" "%TEMP_DIR%\test_a_log.txt" >nul 2>&1
set TEST_A_ISSUES=%errorlevel%

findstr /i "error\|warning" "%TEMP_DIR%\test_b_log.txt" >nul 2>&1  
set TEST_B_ISSUES=%errorlevel%

echo       ðŸ“Š Resultados do teste A/B:
if %TEST_A_ISSUES%==0 (
    echo          âœ… SEM genpts: Sucesso
) else (
    echo          âŒ SEM genpts: Problemas detectados
)

if %TEST_B_ISSUES%==0 (
    echo          âœ… COM genpts: Sucesso
) else (
    echo          âŒ COM genpts: Problemas detectados
)

REM Atualiza recomendaÃ§Ã£o baseada no teste
if %TEST_A_ISSUES% GTR 0 if %TEST_B_ISSUES%==0 (
    set FINAL_RECOMMENDATION=USE_GENPTS
    set CONFIDENCE=HIGH
    echo          ðŸ’¡ RecomendaÃ§Ã£o atualizada: USAR genpts
) else if %TEST_A_ISSUES%==0 if %TEST_B_ISSUES% GTR 0 (
    set FINAL_RECOMMENDATION=NO_GENPTS
    set CONFIDENCE=HIGH
    echo          ðŸ’¡ RecomendaÃ§Ã£o atualizada: NÃƒO usar genpts
) else (
    echo          ðŸ’¡ Ambos funcionaram - use SEM genpts ^(mais rÃ¡pido^)
    set FINAL_RECOMMENDATION=NO_GENPTS
    set CONFIDENCE=MEDIUM
)

echo       ðŸŽ¥ Arquivos de teste salvos em: %OUTPUT_DIR%
echo          - test_sem_genpts.mp4
echo          - test_com_genpts.mp4
echo          - Compare os dois e escolha o melhor

goto :eof

REM ================================
REM FUNÃ‡ÃƒO: Salvar RelatÃ³rio
REM ================================
:save_report
echo Criando relatÃ³rio detalhado...

(
echo ================================
echo INSTAGRAM PTS DIAGNOSTIC REPORT
echo ================================
echo.
echo Data/Hora: %date% %time%
echo Arquivo: %INPUT_FILE%
echo.
echo INFORMAÃ‡Ã•ES BÃSICAS:
echo - DuraÃ§Ã£o: %DURATION%s
echo - ResoluÃ§Ã£o: %WIDTH%x%HEIGHT%  
echo - Frame Rate: %FRAMERATE%
echo - Tipo Source: %SOURCE_TYPE%
echo.
echo PROBLEMAS DETECTADOS:
echo - PTS Warnings: %PTS_WARNINGS%
echo - DTS Warnings: %DTS_WARNINGS%
echo - Sync Warnings: %SYNC_WARNINGS%
echo - Timestamp Issues: %TIMESTAMP_ISSUES%
echo.
echo RECOMENDAÃ‡ÃƒO: %FINAL_RECOMMENDATION%
echo CONFIANÃ‡A: %CONFIDENCE%
echo.
echo ARQUIVOS GERADOS:
if exist "%OUTPUT_DIR%\test_sem_genpts.mp4" echo - test_sem_genpts.mp4
if exist "%OUTPUT_DIR%\test_com_genpts.mp4" echo - test_com_genpts.mp4
echo.
echo ================================
) > "%OUTPUT_DIR%\diagnostic_report.txt"

REM Copia logs tÃ©cnicos
if exist "%TEMP_DIR%\warnings.txt" copy "%TEMP_DIR%\warnings.txt" "%OUTPUT_DIR%\ffmpeg_warnings.txt" >nul
if exist "%TEMP_DIR%\timestamps.csv" copy "%TEMP_DIR%\timestamps.csv" "%OUTPUT_DIR%\timestamps_analysis.csv" >nul
if exist "%TEMP_DIR%\info.json" copy "%TEMP_DIR%\info.json" "%OUTPUT_DIR%\video_info.json" >nul

REM Limpa arquivos temporÃ¡rios
rd /s /q "%TEMP_DIR%" 2>nul

goto :eof